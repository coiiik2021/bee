<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{/admin/template}" >
<head>
  <meta charset="UTF-8">
  <title>Quản lí khách hàng</title>
  <script>

    document.addEventListener('DOMContentLoaded', function() {
      const fileInput = document.getElementById('fileInput');
      if (fileInput) {
        fileInput.addEventListener('change', function() {
          if (this.files.length > 0) {
            document.getElementById('importForm').submit();
          }
        });
      }
    });
  </script>
</head>
<body>
<main class="content px-3 py-4" layout:fragment="main">
  <h1>Quản lí khách hàng</h1>
  <div class="d-flex justify-content-end mt-3">
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addCustomerModal">
      Thêm mới
    </button>
    <button class="btn btn-outline-success ml-5" type="button"
            onclick="window.location.href='/admin/customer/export'">Xuất file</button>
    <form id="importForm" action="/admin/customer/import" method="POST" enctype="multipart/form-data">
      <input type="file" name="file" id="fileInput" required style="display: none;">
      <button class="btn btn-outline-success" type="button" onclick="document.getElementById('fileInput').click();">Nhập file</button>
    </form>
  </div>
  <div id="searchForm" style="display: none" class="mt-3">
    <form  class="form-inline" th:action="@{/admin/customer/search}" method="get" >
      <input type="text" class="form-control mr-2" placeholder="Nhập tên hoặc username" name="searchValue">
      <button class="btn btn-outline-success" type="submit">Tìm kiếm</button>
    </form>
  </div>

  <div class="card mt-5">
    <div class="card-header">
      <h5 class="card-title">Danh sách khách hàng</h5>
    </div>

    <div class="card-body">
      <!-- Bảng Danh sách khách hàng -->
      <table class="table ">
        <thead>
        <tr>
          <th scope="col">STT</th>
          <th scope="col">Username</th>
          <th scope="col">Fullname</th>
          <th scope="col">Email</th>
          <th scope="col">Address</th>
          <th scope="col">City</th>
          <th scope="col">District</th>
          <th scope="col">Ward</th>
          <th scope="col">Country</th>
          <th scope="col">Photo</th>
          <th scope="col">Phone</th>
          <th scope="col">Created Date</th>
          <th scope="col">Status</th>
          <th scope="col">Action</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="customer,stat : ${customers}" >
          <td th:text="${stat.index+1}"></td>
          <td th:text="${customer.username}"></td>
          <td th:text="${customer.fullname}"></td>
          <td th:text="${customer.email}"></td>
          <td th:text="${customer.address}"></td>
          <td th:text="${customer.city}"></td>
          <td th:text="${customer.district}"></td>
          <td th:text="${customer.ward}"></td>
          <td th:text="${customer.country}"></td>
          <td th:text="${customer.photo}"></td>
          <td th:text="${customer.phone}"></td>
          <td th:text="${#temporals.format(customer.createdDate, 'dd-MM-yyyy')}"></td>
          <td th:text="${customer.status==1?'Active':'Inactive'}"></td>

          <td>
            <a th:href="@{/admin/customer/detail/{id}(id=${customer.id})}" class="btn btn-outline-primary" >Detail</a>
            <a th:href="@{/admin/customer/delete/{id}(id=${customer.id})}" class="btn btn-outline-danger" onclick="return confirm('Bạn có chắc muốn xóa')">Delete</a>
          </td>
        </tr>
        </tbody>
      </table>

      <!-- Form chọn số lượng hiển thị -->
      <form id="dataTableForm" method="get" th:action="@{/admin/customer}">
        <div class="dataTables_length" id="DataTables_Table_0_length">
          <label>Show
            <select name="size" onchange="this.form.submit()" class="custom-select custom-select-sm ">
              <option value="10" th:selected="${size == 10}">10</option>
              <option value="25" th:selected="${size == 25}">25</option>
              <option value="50" th:selected="${size == 50}">50</option>
              <option value="100" th:selected="${size == 100}">100</option>
            </select> entries
          </label>
        </div>
      </form>
    </div>
  </div>
<!--      <div class="pagination d-flex justify-content-center">-->
<!--          <li class="paginate_button page-item previous" th:class="${currentPage == 0} ? 'disabled'">-->
<!--              <a th:href="@{/admin/customer(page=${currentPage - 1}, size=${size})}" class="page-link">Previous</a>-->
<!--          </li>-->
<!--          <li class="paginate_button page-item next" th:class="${currentPage + 1 >= totalPages} ? 'disabled'">-->
<!--              <a th:href="@{/admin/customer(page=${currentPage + 1}, size=${size})}" class="btn btn-primary">Next</a>-->
<!--          </li>-->
<!--      </div>-->

  <!--     Modal Thêm Khách Hàng -->
  <div class="modal fade" id="addCustomerModal" tabindex="-1" aria-labelledby="addCustomerModalLabel" aria-hidden="true" >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCustomerModalLabel">Thêm Khách Hàng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form th:action="@{/admin/customer/add}" th:object="${customer}" method="post" >
            <div class="form-group">
              <label>Username</label>
              <input type="text" name="username" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Password</label>
              <input type="password" name="password" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Fullname</label>
              <input type="text" name="fullname" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Email</label>
              <input type="email" name="email" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Address</label>
              <input type="address" name="address" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>City</label>
              <input type="city" name="city" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>District</label>
              <input type="district" name="district" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Ward</label>
              <input type="ward" name="ward" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Country</label>
              <input type="country" name="country" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Phone</label>
              <input type="text" name="phone" class="form-control" required/>
            </div>

            <div class="form-group">
              <label>Status</label><br>
              <input type="radio"  name="status" value="1">
              <label>Active</label>
              <input class="ml-5" type="radio"  name="status" value="0">
              <label>Inactive</label>
            </div>

            <div class="form-group">
              <label for="photo">Photo</label>
              <input type="file" name="photo" id="photo" class="form-control" accept="image/*">
            </div>

            <div class="d-flex justify-content-center">
              <button type="submit" class="btn btn-primary me-2">Save</button>
            </div>

          </form>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(document).ready(function () {
      // Xử lý submit form
      $('#addEmployeeForm').submit(function (event) {
        event.preventDefault(); // Ngăn chặn form submit truyền thống

        // Xóa các thông báo lỗi cũ trước khi hiển thị cái mới
        $('#usernameError').text('');
        $('#emailError').text('');
        $('#phoneError').text('');

        $.ajax({
          url: '/admin/employee/add',
          type: 'POST',
          data: $(this).serialize(),
          success: function () {
            // Nếu thành công, đóng modal và tải lại danh sách nhân viên
            $('#addEmployeeModal').modal('hide');
            location.reload(); // Tải lại trang để cập nhật danh sách
          },
          error: function (xhr) {
            // Khi có lỗi, hiển thị thông báo lỗi ngay trên modal
            var errors = xhr.responseJSON;
            if (errors.username) {
              $('#usernameError').text(errors.username);
            }
            if (errors.email) {
              $('#emailError').text(errors.email);
            }
            if (errors.phone) {
              $('#phoneError').text(errors.phone);
            }
            // Mở lại modal khi có lỗi từ server
            $('#addEmployeeModal').modal('show');
          }
        });
      });

      // Mở modal khi cần hiển thị lỗi sau khi tải lại trang
      const showModal = [[${showModal}]];
      if (showModal) {
        $('#addEmployeeModal').modal('show');
      }
    });
  </script>
</main>
</body>
</html>